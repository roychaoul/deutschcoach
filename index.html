<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0A0E17">
<meta name="description" content="DeutschCoach - Dein KI-Sprachpartner zum Deutsch lernen">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>DeutschCoach</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
<style>
:root{--bg:#0A0E17;--bg2:#111827;--cd:#1A2235;--cd2:#1F2A40;--gd:#F5A623;--gdd:rgba(245,166,35,.15);--bl:#3B82F6;--gn:#10B981;--rd:#EF4444;--pu:#8B5CF6;--or:#F97316;--tl:#14B8A6;--t1:#F1F5F9;--t2:#94A3B8;--t3:#64748B;--bd:rgba(255,255,255,.06);--ba:rgba(245,166,35,.3);--sh:0 4px 24px rgba(0,0,0,.4);--r:16px;--rs:10px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--t1);min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased}
.amb{position:fixed;inset:0;z-index:0;pointer-events:none}.amb::before{content:'';position:absolute;top:-30%;left:-20%;width:70%;height:70%;background:radial-gradient(ellipse,rgba(245,166,35,.06),transparent 70%);animation:dr 20s ease-in-out infinite}.amb::after{content:'';position:absolute;bottom:-20%;right:-20%;width:60%;height:60%;background:radial-gradient(ellipse,rgba(59,130,246,.04),transparent 70%);animation:dr 25s ease-in-out infinite reverse}@keyframes dr{0%,100%{transform:translate(0,0)}50%{transform:translate(30px,-20px)}}
.app{position:relative;z-index:1;max-width:480px;margin:0 auto;min-height:100dvh;display:flex;flex-direction:column}
/* Header */
.hdr{padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--bd);backdrop-filter:blur(20px);background:rgba(10,14,23,.85);position:sticky;top:0;z-index:100}
.hdr-l{display:flex;align-items:center;gap:10px}
.logo{width:36px;height:36px;background:linear-gradient(135deg,var(--gd),#E8930C);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:var(--bg);font-family:'DM Serif Display',serif;box-shadow:0 2px 10px rgba(245,166,35,.3)}
.hdr-t{font-family:'DM Serif Display',serif;font-size:18px}.hdr-s{font-size:9px;color:var(--t3);font-weight:500;letter-spacing:.5px;text-transform:uppercase}
.streak{display:flex;align-items:center;gap:4px;background:var(--gdd);border:1px solid rgba(245,166,35,.2);padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;color:var(--gd)}
/* Screens */
.scr{display:none;flex-direction:column;flex:1}.scr.on{display:flex}
.home{padding:16px;flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}
/* Level selector */
.lvs{display:flex;gap:3px;margin-bottom:14px;background:var(--cd);border-radius:11px;padding:3px;border:1px solid var(--bd)}
.lvb{flex:1;padding:9px 2px;border:none;background:none;color:var(--t3);font-family:inherit;font-size:13px;font-weight:700;border-radius:8px;cursor:pointer;transition:all .2s;text-align:center}
.lvb.on{color:var(--bg)}
.lvb[data-l=A1].on{background:var(--gn)}.lvb[data-l=A2].on{background:var(--tl)}.lvb[data-l=B1].on{background:var(--bl)}.lvb[data-l=B2].on{background:var(--pu)}.lvb[data-l=C1].on{background:var(--or)}
.lvi{border-radius:var(--r);padding:14px;margin-bottom:14px;border:1px solid rgba(255,255,255,.08)}
.lvi h2{font-family:'DM Serif Display',serif;font-size:18px;margin-bottom:3px}
.lvi p{font-size:11px;color:var(--t2);line-height:1.5}
.lvt{display:flex;flex-wrap:wrap;gap:4px;margin-top:7px}
.lvt span{font-size:9px;font-weight:600;padding:2px 7px;border-radius:5px;background:rgba(255,255,255,.06);color:var(--t2)}
/* Stats */
.sts{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;margin-bottom:14px}
.st{background:var(--cd);border:1px solid var(--bd);border-radius:var(--rs);padding:10px;text-align:center}
.st b{font-family:'DM Serif Display',serif;font-size:20px;color:var(--gd);display:block}
.st small{font-size:9px;color:var(--t3);display:block;margin-top:1px}
/* Quick actions */
.qa{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:14px}
.qab{background:var(--cd);border:1px solid var(--bd);border-radius:var(--rs);padding:11px;color:var(--t1);font-family:inherit;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:5px;justify-content:center}
.qab:hover{border-color:var(--ba);background:var(--cd2)}
/* Category */
.cs{margin-bottom:14px}
.ch{display:flex;align-items:center;gap:7px;margin-bottom:7px;cursor:pointer;user-select:none;padding:3px 0}
.ch .ci{font-size:16px}.ch .cn{font-family:'DM Serif Display',serif;font-size:14px;flex:1}
.ch .cc{font-size:9px;color:var(--t3);background:var(--cd);padding:2px 7px;border-radius:9px;font-weight:600}
.ch .ca{color:var(--t3);font-size:11px;transition:transform .2s}.ch .ca.op{transform:rotate(90deg)}
.sg{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.sc{background:var(--cd);border:1px solid var(--bd);border-radius:12px;padding:12px 10px;cursor:pointer;transition:all .2s;overflow:hidden}
.sc:hover{border-color:var(--ba);transform:translateY(-1px);box-shadow:var(--sh)}
.sc .si{font-size:22px;margin-bottom:5px;display:block}.sc .sn{font-weight:600;font-size:11px;margin-bottom:2px;line-height:1.3}
.sc .sd{font-size:9px;color:var(--t3);line-height:1.3}.sc .sl{display:inline-block;margin-top:5px;font-size:8px;font-weight:700;padding:2px 6px;border-radius:4px;text-transform:uppercase;letter-spacing:.4px}
.bA1{background:rgba(16,185,129,.15);color:var(--gn)}.bA2{background:rgba(20,184,166,.15);color:var(--tl)}.bB1{background:rgba(59,130,246,.15);color:var(--bl)}.bB2{background:rgba(139,92,246,.15);color:var(--pu)}.bC1{background:rgba(249,115,22,.15);color:var(--or)}
/* Chat */
.chdr{padding:10px 14px;border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:8px;backdrop-filter:blur(20px);background:rgba(10,14,23,.9)}
.bk{background:none;border:none;color:var(--t2);font-size:18px;cursor:pointer;padding:3px;display:flex;align-items:center}
.cinf{flex:1}.cinf .n{font-weight:600;font-size:13px}.cinf .h{font-size:9px;color:var(--t3)}
.ctg{font-size:9px;font-weight:700;padding:3px 7px;border-radius:5px}
.cstb{background:none;border:none;color:var(--t3);font-size:16px;cursor:pointer;padding:3px}
.msgs{flex:1;overflow-y:auto;padding:12px 14px;display:flex;flex-direction:column;gap:8px;scroll-behavior:smooth}
.msg{max-width:88%;padding:11px 13px;border-radius:14px;font-size:13px;line-height:1.5;animation:mi .3s ease}
@keyframes mi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.msg.bot{background:var(--cd);border:1px solid var(--bd);border-bottom-left-radius:4px;align-self:flex-start}
.msg.usr{background:linear-gradient(135deg,rgba(245,166,35,.2),rgba(245,166,35,.08));border:1px solid rgba(245,166,35,.15);border-bottom-right-radius:4px;align-self:flex-end}
.msg.sys{background:rgba(59,130,246,.07);border:1px solid rgba(59,130,246,.1);align-self:center;text-align:center;font-size:10px;color:var(--bl);max-width:92%;border-radius:9px;padding:6px 12px}
.cor{margin-top:7px;padding:8px 10px;background:rgba(239,68,68,.07);border:1px solid rgba(239,68,68,.1);border-radius:8px;font-size:12px}
.cor .lb{font-size:8px;text-transform:uppercase;letter-spacing:.8px;color:var(--rd);font-weight:700;margin-bottom:3px}
.cor .cw{text-decoration:line-through;color:var(--rd);opacity:.7}.cor .cr{color:var(--gn);font-weight:600}
.cor .ce{margin-top:4px;font-size:10px;color:var(--t2);line-height:1.5}
.voc{margin-top:7px;padding:8px 10px;background:rgba(59,130,246,.07);border:1px solid rgba(59,130,246,.1);border-radius:8px;font-size:11px;color:var(--bl)}
.hnt{margin-top:7px;padding:8px 10px;background:rgba(139,92,246,.07);border:1px solid rgba(139,92,246,.1);border-radius:8px;font-size:11px;color:var(--pu)}
.voc .lb,.hnt .lb{font-size:8px;text-transform:uppercase;letter-spacing:.8px;font-weight:700;margin-bottom:2px}
.spk{display:inline-flex;align-items:center;gap:3px;background:rgba(255,255,255,.06);border:none;border-radius:5px;padding:2px 6px;margin-top:5px;font-size:9px;color:var(--t3);cursor:pointer;font-family:inherit}.spk:hover{background:rgba(255,255,255,.1)}
.typ{display:flex;gap:4px;padding:11px 13px;align-self:flex-start;background:var(--cd);border:1px solid var(--bd);border-radius:14px;border-bottom-left-radius:4px}
.dot{width:5px;height:5px;background:var(--t3);border-radius:50%;animation:tb 1.4s ease-in-out infinite}
.dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
@keyframes tb{0%,60%,100%{transform:translateY(0);opacity:.4}30%{transform:translateY(-4px);opacity:1}}
/* Input */
.ibar{padding:8px 12px;border-top:1px solid var(--bd);background:rgba(10,14,23,.95);backdrop-filter:blur(20px)}
.mtb{display:flex;gap:2px;margin-bottom:6px;background:var(--cd);border-radius:8px;padding:2px}
.mt{flex:1;padding:5px;border:none;background:none;color:var(--t3);font-family:inherit;font-size:10px;font-weight:600;border-radius:6px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:4px}
.mt.on{background:rgba(245,166,35,.15);color:var(--gd)}
.tir{display:flex;gap:6px;align-items:flex-end}
.tir textarea{flex:1;background:var(--cd);border:1px solid var(--bd);border-radius:11px;padding:9px 12px;color:var(--t1);font-family:inherit;font-size:14px;resize:none;outline:none;min-height:40px;max-height:100px;transition:border-color .2s;line-height:1.4}
.tir textarea:focus{border-color:var(--ba)}.tir textarea::placeholder{color:var(--t3)}
.snd{width:40px;height:40px;border-radius:10px;border:none;background:linear-gradient(135deg,var(--gd),#E8930C);color:var(--bg);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.via{display:none;flex-direction:column;align-items:center;gap:8px;padding:4px 0}.via.on{display:flex}
.tia.off{display:none}
.mic{width:54px;height:54px;border-radius:50%;border:3px solid var(--gd);background:rgba(245,166,35,.1);color:var(--gd);font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.mic.rec{animation:mp 1.5s ease-in-out infinite;border-color:var(--rd);background:rgba(239,68,68,.15);color:var(--rd)}
@keyframes mp{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.3)}50%{box-shadow:0 0 0 10px rgba(239,68,68,0)}}
.vst{font-size:10px;color:var(--t3);font-weight:500}
.vtr{font-size:11px;color:var(--t2);background:var(--cd);border-radius:8px;padding:7px 10px;width:100%;text-align:center;font-style:italic}
/* Modal */
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;align-items:center;justify-content:center;padding:16px;backdrop-filter:blur(4px)}.mo.on{display:flex}
.moc{background:var(--bg2);border:1px solid var(--bd);border-radius:var(--r);padding:22px 18px;width:100%;max-width:400px;box-shadow:var(--sh)}
.moc h3{font-family:'DM Serif Display',serif;font-size:18px;margin-bottom:5px}
.moc p{font-size:11px;color:var(--t2);margin-bottom:14px;line-height:1.5}
.moc input,.moc select{width:100%;background:var(--cd);border:1px solid var(--bd);border-radius:var(--rs);padding:10px 12px;color:var(--t1);font-family:'JetBrains Mono',monospace;font-size:12px;outline:none;margin-bottom:12px}
.moc input:focus{border-color:var(--ba)}.moc input::placeholder{color:var(--t3)}
.moa{display:flex;gap:7px}
.mob{flex:1;padding:10px;border-radius:var(--rs);border:none;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s}
.mob.p{background:linear-gradient(135deg,var(--gd),#E8930C);color:var(--bg)}.mob.s{background:var(--cd);color:var(--t2);border:1px solid var(--bd)}
.apis{font-size:10px;margin-top:8px;padding:7px 9px;border-radius:7px;display:none}
.apis.ok{display:block;background:rgba(16,185,129,.1);color:var(--gn);border:1px solid rgba(16,185,129,.2)}
.apis.er{display:block;background:rgba(239,68,68,.1);color:var(--rd);border:1px solid rgba(239,68,68,.2)}
/* Settings */
.setp{display:none;position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;background:var(--bg2);border-top:1px solid var(--bd);border-radius:16px 16px 0 0;padding:18px 16px;z-index:500;box-shadow:0 -8px 40px rgba(0,0,0,.5);max-height:75vh;overflow-y:auto}.setp.on{display:block}
.setp h3{font-family:'DM Serif Display',serif;font-size:16px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
.setp .x{background:none;border:none;color:var(--t3);font-size:18px;cursor:pointer}
.sr{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid var(--bd)}
.sr .sl{font-size:12px;font-weight:500}.sr .sl small{display:block;font-size:9px;color:var(--t3);font-weight:400;margin-top:1px}
.tg{width:40px;height:21px;background:var(--cd);border-radius:11px;position:relative;cursor:pointer;border:1px solid var(--bd);transition:all .2s;flex-shrink:0}
.tg.on{background:rgba(245,166,35,.2);border-color:var(--gd)}
.tg::after{content:'';position:absolute;width:15px;height:15px;background:var(--t3);border-radius:50%;top:2px;left:2px;transition:all .2s}
.tg.on::after{transform:translateX(19px);background:var(--gd)}
/* Nav */
.nav{display:flex;border-top:1px solid var(--bd);background:rgba(10,14,23,.95);backdrop-filter:blur(20px);padding:5px 0 calc(5px + env(safe-area-inset-bottom))}
.ni{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 0;background:none;border:none;color:var(--t3);font-family:inherit;font-size:8px;font-weight:600;cursor:pointer;transition:color .2s}
.ni .ic{font-size:18px}.ni.on{color:var(--gd)}
/* Mistakes & History */
.mist{padding:14px;flex:1;overflow-y:auto}
.mk{background:var(--cd);border:1px solid var(--bd);border-radius:var(--rs);padding:12px;margin-bottom:7px}
.mk .mw{color:var(--rd);text-decoration:line-through;font-size:12px}.mk .mr{color:var(--gn);font-weight:600;font-size:12px;margin-top:2px}
.mk .me{font-size:10px;color:var(--t3);margin-top:4px;padding-top:4px;border-top:1px solid var(--bd)}
.mk .mc{display:inline-block;font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;padding:2px 6px;border-radius:4px;margin-bottom:5px}
.cg{background:rgba(239,68,68,.1);color:var(--rd)}.cv{background:rgba(59,130,246,.1);color:var(--bl)}.cw{background:rgba(139,92,246,.1);color:var(--pu)}
/* History cards */
.hc{background:var(--cd);border:1px solid var(--bd);border-radius:var(--rs);padding:12px;margin-bottom:7px;cursor:pointer;transition:all .2s}
.hc:hover{border-color:var(--ba)}
.hc .ht{font-weight:600;font-size:12px;margin-bottom:2px}.hc .hd{font-size:10px;color:var(--t3)}
.hc .hm{font-size:9px;color:var(--t2);margin-top:4px;font-style:italic;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.htabs{display:flex;gap:3px;margin-bottom:12px;background:var(--cd);border-radius:8px;padding:2px}
.htab{flex:1;padding:7px;border:none;background:none;color:var(--t3);font-family:inherit;font-size:11px;font-weight:600;border-radius:6px;cursor:pointer;text-align:center;transition:all .2s}
.htab.on{background:rgba(245,166,35,.15);color:var(--gd)}
/* Export/Import bar */
.eibar{display:flex;gap:6px;margin-bottom:12px}
.eib{flex:1;padding:9px;background:var(--cd);border:1px solid var(--bd);border-radius:8px;font-family:inherit;font-size:10px;font-weight:600;color:var(--t1);cursor:pointer;text-align:center;transition:all .2s}
.eib:hover{border-color:var(--ba)}
.empty{text-align:center;padding:40px 16px;color:var(--t3)}.empty .ic{font-size:36px;margin-bottom:8px}.empty p{font-size:12px}
::-webkit-scrollbar{width:2px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bd);border-radius:2px}
</style>
</head>
<body>
<div class="amb"></div>
<div class="app">

<!-- HOME -->
<div class="scr on" id="homeScr">
<div class="hdr"><div class="hdr-l"><div class="logo">D</div><div><div class="hdr-t">DeutschCoach</div><div class="hdr-s">KI-Sprachpartner</div></div></div><div class="streak">üî• <span id="strk">0</span> Tage</div></div>
<div class="home">
<div class="lvs" id="lvlS"></div>
<div class="lvi" id="lvI"></div>
<div class="sts"><div class="st"><b id="s1">0</b><small>Gespr√§che</small></div><div class="st"><b id="s2">0</b><small>Korrekturen</small></div><div class="st"><b id="s3">0</b><small>Neue W√∂rter</small></div></div>
<div class="qa">
<button class="qab" onclick="startFree()">üí¨ Freies Gespr√§ch</button>
<button class="qab" onclick="showApi()">üîë API-Key</button>
<button class="qab" onclick="go('hist')">üìÇ Gespeicherte Chats</button>
<button class="qab" onclick="go('data')">üíæ Daten sichern</button>
</div>
<div id="scenBox"></div>
</div>
<nav class="nav">
<button class="ni on" onclick="go('home')"><span class="ic">üè†</span>Home</button>
<button class="ni" onclick="startFree()"><span class="ic">üí¨</span>Chat</button>
<button class="ni" onclick="go('hist')"><span class="ic">üìÇ</span>Verlauf</button>
<button class="ni" onclick="go('mist')"><span class="ic">üìù</span>Fehler</button>
</nav>
</div>

<!-- CHAT -->
<div class="scr" id="chatScr">
<div class="chdr"><button class="bk" onclick="endChat()">‚Üê</button><div class="cinf"><div class="n" id="chN">üí¨</div><div class="h" id="chH"></div></div><span class="ctg" id="chT">A1</span><button class="cstb" onclick="togSet()">‚öôÔ∏è</button></div>
<div class="msgs" id="msgs"></div>
<div class="ibar">
<div class="mtb"><button class="mt on" id="mtT" onclick="setMode('t')">‚å®Ô∏è Tippen</button><button class="mt" id="mtV" onclick="setMode('v')">üé§ Sprechen</button></div>
<div class="tia" id="tia"><div class="tir"><textarea id="inp" placeholder="Schreib auf Deutsch..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();send()}" oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,100)+'px'"></textarea><button class="snd" onclick="send()">‚û§</button></div></div>
<div class="via" id="via"><div class="vtr" id="vtr">Dr√ºcke und sprich...</div><button class="mic" id="micB" onclick="togRec()">üé§</button><div class="vst" id="vst">Tippe zum Sprechen</div></div>
</div>
<div class="setp" id="setP">
<h3>Einstellungen<button class="x" onclick="togSet()">‚úï</button></h3>
<div class="sr"><div class="sl">Automatische Korrektur<small>Jeden Satz korrigieren</small></div><div class="tg on" id="tgCor" onclick="togS(this)"></div></div>
<div class="sr"><div class="sl">Vokabelhilfe<small>Neue W√∂rter erkl√§ren</small></div><div class="tg on" id="tgVoc" onclick="togS(this)"></div></div>
<div class="sr"><div class="sl">Aussprache-Tipps</div><div class="tg on" id="tgPro" onclick="togS(this)"></div></div>
<div class="sr"><div class="sl">Strenger Modus<small>Nur Deutsch</small></div><div class="tg" id="tgStr" onclick="togS(this)"></div></div>
<div class="sr"><div class="sl">Langsames Tempo<small>An Niveau anpassen</small></div><div class="tg on" id="tgSlo" onclick="togS(this)"></div></div>
</div>
</div>

<!-- HISTORY & MISTAKES -->
<div class="scr" id="histScr">
<div class="hdr"><div class="hdr-l"><button class="bk" onclick="go('home')" style="margin-right:4px">‚Üê</button><div><div class="hdr-t">Verlauf & Fehler</div><div class="hdr-s">Deine Lerngeschichte</div></div></div></div>
<div class="mist">
<div class="htabs"><button class="htab on" id="htC" onclick="showHTab('chats')">üí¨ Chats</button><button class="htab" id="htM" onclick="showHTab('mist')">üìù Fehler</button></div>
<div class="eibar"><button class="eib" onclick="exportData()">üì§ Exportieren</button><button class="eib" onclick="$('impF').click()">üì• Importieren</button><input type="file" id="impF" accept=".json" style="display:none" onchange="importData(event)"></div>
<div id="histBox"></div>
</div>
<nav class="nav">
<button class="ni" onclick="go('home')"><span class="ic">üè†</span>Home</button>
<button class="ni" onclick="startFree()"><span class="ic">üí¨</span>Chat</button>
<button class="ni on"><span class="ic">üìÇ</span>Verlauf</button>
<button class="ni" onclick="go('mist')"><span class="ic">üìù</span>Fehler</button>
</nav>
</div>

<!-- DATA SCREEN (alias for hist) -->
<div class="scr" id="mistScr">
<div class="hdr"><div class="hdr-l"><button class="bk" onclick="go('home')" style="margin-right:4px">‚Üê</button><div><div class="hdr-t">Meine Fehler</div><div class="hdr-s">Lerne aus Fehlern</div></div></div></div>
<div class="mist" id="mistC"><div class="empty"><div class="ic">üìù</div><p>Noch keine Fehler!</p></div></div>
<nav class="nav">
<button class="ni" onclick="go('home')"><span class="ic">üè†</span>Home</button>
<button class="ni" onclick="startFree()"><span class="ic">üí¨</span>Chat</button>
<button class="ni" onclick="go('hist')"><span class="ic">üìÇ</span>Verlauf</button>
<button class="ni on"><span class="ic">üìù</span>Fehler</button>
</nav>
</div>

</div>

<!-- API Modal -->
<div class="mo" id="apiMo"><div class="moc"><h3>üîë Claude API-Key</h3><p>Dein Key wird nur lokal gespeichert und nie geteilt.</p><input type="password" id="apiIn" placeholder="sk-ant-api03-..." autocomplete="off"><div class="moa"><button class="mob s" onclick="closeApi()">Abbrechen</button><button class="mob p" onclick="saveApi()">Speichern</button></div><div class="apis" id="apiS"></div></div></div>

<script>
// PWA Service Worker
if('serviceWorker' in navigator){navigator.serviceWorker.register('./sw.js').then(()=>console.log('SW registered')).catch(e=>console.log('SW failed',e));}

const LV={
A1:{nm:'A1 ‚Äî Anf√§nger',co:'var(--gn)',bg:'rgba(16,185,129,.08)',bd:'rgba(16,185,129,.15)',ds:'Einfache S√§tze, Begr√º√üungen, sich vorstellen.',tg:['Pr√§sens','W-Fragen','Nominativ','Grundwortschatz'],rt:.75,gr:'Pr√§sens, Nominativ/Akkusativ, Artikel, einfache Satzstruktur'},
A2:{nm:'A2 ‚Äî Grundkenntnisse',co:'var(--tl)',bg:'rgba(20,184,166,.08)',bd:'rgba(20,184,166,.15)',ds:'Alltag, Vergangenheit, W√ºnsche. Perfekt, Modalverben.',tg:['Perfekt','Modalverben','Dativ','Nebens√§tze'],rt:.8,gr:'Perfekt, Modalverben, Dativ, Nebens√§tze, trennbare Verben'},
B1:{nm:'B1 ‚Äî Mittelstufe',co:'var(--bl)',bg:'rgba(59,130,246,.08)',bd:'rgba(59,130,246,.15)',ds:'Meinungen, Pl√§ne, Erfahrungen. Konjunktiv II.',tg:['Konjunktiv II','Relativs√§tze','Passiv','Pr√§teritum'],rt:.85,gr:'Konjunktiv II (w√ºrde), Relativs√§tze, Passiv Pr√§sens, Pr√§teritum'},
B2:{nm:'B2 ‚Äî Obere Mittelstufe',co:'var(--pu)',bg:'rgba(139,92,246,.08)',bd:'rgba(139,92,246,.15)',ds:'Komplexe Diskussionen, Argumente, Fachsprache.',tg:['Konjunktiv II','Passiv','Konnektoren','Fachsprache'],rt:.9,gr:'Konjunktiv II alle Formen, Passiv alle Zeiten, Partizip als Adjektiv'},
C1:{nm:'C1 ‚Äî Fortgeschritten',co:'var(--or)',bg:'rgba(249,115,22,.08)',bd:'rgba(249,115,22,.15)',ds:'Nuancierte Argumentation, Konjunktiv I, Idiome.',tg:['Konjunktiv I','Idiome','Partizipialgruppen','Stilebenen'],rt:.95,gr:'Konjunktiv I, Partizipialgruppen, Funktionsverbgef√ºge'}
};

const SC=[
// FREE
{id:'f_any',c:'free',i:'üó£Ô∏è',n:'Freies Thema',d:'Sprich √ºber was du willst',l:'A1',p:'Freies Gespr√§ch. Passe dich dem Thema an. Schlage Themen vor wenn n√∂tig.'},
{id:'f_tag',c:'free',i:'üåÖ',n:'Mein Tag',d:'Erz√§hle von deinem Tag',l:'A1',p:'H√∂re zu, stelle einfache Fragen: Was hast du gemacht? Wo warst du?'},
{id:'f_hobby',c:'free',i:'üé®',n:'Hobbys',d:'√úber Hobbys und Interessen',l:'A1',p:'Sprecht √ºber Hobbys. Was machst du gern? Seit wann? Warum?'},
{id:'f_wetter',c:'free',i:'üå¶Ô∏è',n:'Wetter',d:'√úber das Wetter reden',l:'A1',p:'Sprecht √ºbers Wetter. Wie ist es heute? Was machst du gern bei Sonne/Regen?'},
{id:'f_fam',c:'free',i:'üë®‚Äçüë©‚Äçüëß',n:'Familie',d:'√úber Familie sprechen',l:'A2',p:'Sprecht √ºber Familie. Wer geh√∂rt dazu? Was machen sie?'},
{id:'f_reise',c:'free',i:'‚úàÔ∏è',n:'Reiseerlebnisse',d:'Von Reisen erz√§hlen',l:'A2',p:'Erz√§hle von Reisen. Wohin? Was erlebt? Was empfiehlst du?'},
{id:'f_film',c:'free',i:'üé¨',n:'Lieblingsfilm',d:'Filme empfehlen und diskutieren',l:'B1',p:'Besprecht Lieblingsfilme. Handlung, warum gut, Empfehlungen.'},
{id:'f_zukunft',c:'free',i:'üîÆ',n:'Zukunftspl√§ne',d:'Tr√§ume und Ziele',l:'B1',p:'√úber Zukunftspl√§ne sprechen. Was m√∂chtest du erreichen?'},
{id:'f_meinung',c:'free',i:'üí≠',n:'Meinung √§u√üern',d:'Ein Thema diskutieren',l:'B2',p:'Diskutiere ein Thema. Argumente bilden, Meinung austauschen.'},
{id:'f_kultur',c:'free',i:'üåé',n:'Kulturunterschiede',d:'Kulturen vergleichen',l:'B2',p:'Kulturunterschiede DE vs. andere L√§nder. Sitten, Arbeitskultur.'},
// DAILY
{id:'greet',c:'daily',i:'üëã',n:'Sich vorstellen',d:'Name, Herkunft, Hobbys',l:'A1',p:'Erstes Treffen. Vorstellen, nach Name, Alter, Herkunft fragen.'},
{id:'cafe',c:'daily',i:'‚òï',n:'Im Caf√©',d:'Getr√§nke bestellen',l:'A1',p:'Kellner/in im Caf√©. Bestellung aufnehmen. Einfache S√§tze.'},
{id:'weg',c:'daily',i:'üó∫Ô∏è',n:'Nach dem Weg',d:'Orientierung in der Stadt',l:'A1',p:'Tourist fragt nach dem Weg. Geradeaus, links, rechts.'},
{id:'super',c:'daily',i:'üõí',n:'Im Supermarkt',d:'Einkaufen, Produkte, Preise',l:'A2',p:'Verk√§ufer im Supermarkt. Produkte suchen, Preise, Angebote.'},
{id:'rest',c:'daily',i:'üçΩÔ∏è',n:'Im Restaurant',d:'Bestellen, Bezahlen',l:'A2',p:'Kellner/in. Gerichte empfehlen, Bestellung, Sonderw√ºnsche, Rechnung.'},
{id:'kleid',c:'daily',i:'üëó',n:'Kleidung kaufen',d:'Gr√∂√üen, Farben, Umtausch',l:'A2',p:'Bekleidungsgesch√§ft. Gr√∂√üen, Farben, Stil beraten, Umtausch.'},
{id:'markt',c:'daily',i:'ü•ï',n:'Wochenmarkt',d:'Frisches Obst und Gem√ºse',l:'A2',p:'Wochenmarkt-Verk√§ufer. Preise, Mengen, saisonale Empfehlungen.'},
{id:'koch',c:'daily',i:'üë®‚Äçüç≥',n:'Zusammen kochen',d:'Rezept besprechen',l:'B1',p:'Gemeinsam kochen. Rezept, Zutaten, Zubereitungsschritte.'},
{id:'fris',c:'daily',i:'üíá',n:'Beim Friseur',d:'Haarschnitt, Smalltalk',l:'B1',p:'Friseur/in. Gew√ºnschter Schnitt, Beratung, Smalltalk.'},
{id:'umzug',c:'daily',i:'üì¶',n:'Umzug planen',d:'M√∂bel, Ummeldung',l:'B1',p:'Umzug planen: M√∂bel, Umzugsfirma, Adresse ummelden.'},
{id:'reklam',c:'daily',i:'üò§',n:'Reklamation',d:'Beschwerde, R√ºckgabe',l:'B2',p:'Kundenservice. Produkt-Beschwerde professionell handeln.'},
// TRANSPORT
{id:'bus',c:'trans',i:'üöå',n:'Bus & Bahn',d:'Fahrkarte, Verbindungen',l:'A1',p:'Fahrkartenschalter. Wohin? Wann? Einfach/Hin-Zur√ºck?'},
{id:'taxi',c:'trans',i:'üöï',n:'Im Taxi',d:'Ziel, Smalltalk',l:'A2',p:'Taxifahrer. Zum Ziel fahren, Smalltalk √ºber die Stadt.'},
{id:'flug',c:'trans',i:'‚úàÔ∏è',n:'Am Flughafen',d:'Check-in, Gate, Probleme',l:'B1',p:'Flughafen. Check-in, Gep√§ck, Gate finden, Versp√§tungen.'},
{id:'auto',c:'trans',i:'üöó',n:'Autovermietung',d:'Auto mieten',l:'B1',p:'Autovermietung. Fahrzeugtypen, Versicherung, R√ºckgabe.'},
{id:'werk',c:'trans',i:'üîß',n:'Werkstatt',d:'Autopanne, Reparatur',l:'B2',p:'KFZ-Mechaniker. Diagnose, Kosten, Reparaturplan.'},
// HEALTH
{id:'apo',c:'health',i:'üíä',n:'Apotheke',d:'Medikamente, Symptome',l:'A2',p:'Apotheker/in. Symptome h√∂ren, Medikamente empfehlen, Dosierung.'},
{id:'arzt',c:'health',i:'üè•',n:'Beim Hausarzt',d:'Termin, Symptome',l:'B1',p:'Arzt/√Ñrztin. Symptome, Krankengeschichte, Empfehlungen.'},
{id:'zahn',c:'health',i:'ü¶∑',n:'Zahnarzt',d:'Zahnschmerzen',l:'B1',p:'Zahnarzt/Zahn√§rztin. Symptome, Behandlung erkl√§ren.'},
{id:'krank',c:'health',i:'üöë',n:'Krankenhaus',d:'Notaufnahme, Visite',l:'B2',p:'Krankenhaus. Notaufnahme, Aufnahme, Visite, Entlassung.'},
{id:'ther',c:'health',i:'üß†',n:'Therapeut',d:'Stress, Gef√ºhle',l:'B2',p:'Therapeut/in. Stress, Gef√ºhle, Work-Life-Balance.'},
// WORK
{id:'tag1',c:'work',i:'üè¢',n:'Erster Arbeitstag',d:'Sich vorstellen',l:'A2',p:'Erster Tag. Kollegen vorstellen, B√ºro, Kantine, Zeiten.'},
{id:'tel',c:'work',i:'üìû',n:'Gesch√§ftstelefonate',d:'Anrufe, Termine',l:'B1',p:'B√ºro-Telefonate. Entgegennehmen, verbinden, Nachricht, Termin.'},
{id:'meet',c:'work',i:'üìä',n:'Im Meeting',d:'Ideen, Diskussion',l:'B1',p:'Team-Meeting leiten. Projekt, Ideen, n√§chste Schritte.'},
{id:'bew',c:'work',i:'üíº',n:'Vorstellungsgespr√§ch',d:'Erfahrung, Motivation',l:'B2',p:'Personalleiter. Erfahrung, Motivation, St√§rken, Gehalt.'},
{id:'pras',c:'work',i:'üìà',n:'Pr√§sentation',d:'Daten vorstellen',l:'B2',p:'Gesch√§ftspr√§sentation. Strukturieren, Fragen beantworten.'},
{id:'kund',c:'work',i:'ü§ù',n:'Kundengespr√§ch',d:'Produkt, Verhandlung',l:'B2',p:'Du bist Kunde. Kritische Fragen, Konditionen verhandeln.'},
{id:'geh',c:'work',i:'üí∞',n:'Gehaltsverhandlung',d:'Gehalt verhandeln',l:'C1',p:'Gehaltsverhandlung. Argumente, Benefits, Kompromisse.'},
{id:'konf',c:'work',i:'‚ö°',n:'Teamkonflikt',d:'Probleme l√∂sen',l:'C1',p:'Teamkonflikt diplomatisch l√∂sen. Deeskalierende Kommunikation.'},
// HOUSING
{id:'wanz',c:'hous',i:'üîç',n:'Wohnungsanzeige',d:'Anrufen, Fragen',l:'A2',p:'Wohnungsanzeige. Gr√∂√üe, Miete, Lage, Einzugsdatum.'},
{id:'nach',c:'hous',i:'üèòÔ∏è',n:'Nachbarn',d:'Vorstellen, Regeln',l:'A2',p:'Neuer Nachbar. Vorstellen, Hausregeln, M√ºlltonnen.'},
{id:'bes',c:'hous',i:'üè†',n:'Besichtigung',d:'Wohnung anschauen',l:'B1',p:'Wohnung zeigen. Zimmer, Ausstattung, Miete, Nebenkosten.'},
{id:'hand',c:'hous',i:'üî®',n:'Handwerker',d:'Reparatur bestellen',l:'B1',p:'Handwerker. Problem beschreiben, Kosten, Termin.'},
{id:'verm',c:'hous',i:'üîë',n:'Vermieter',d:'Probleme melden',l:'B2',p:'Vermieter. Problem melden, L√∂sungen besprechen.'},
// SOCIAL
{id:'party',c:'social',i:'üéâ',n:'Auf einer Party',d:'Smalltalk, neue Leute',l:'A2',p:'Hausparty. Smalltalk: Hobbys, Arbeit, Wochenende.'},
{id:'geb',c:'social',i:'üéÇ',n:'Geburtstag',d:'Gl√ºckw√ºnsche, Geschenke',l:'A2',p:'Geburtstagsfeier. Gratulieren, Geschenk, lustige Geschichten.'},
{id:'kneipe',c:'social',i:'üç∫',n:'In der Kneipe',d:'Abend mit Freunden',l:'B1',p:'Kneipe. Getr√§nke, Fu√üball, Filme, Reisen diskutieren.'},
{id:'date',c:'social',i:'‚ù§Ô∏è',n:'Erstes Date',d:'Kennenlernen',l:'B1',p:'Erstes Date. Kennenlernen, Interessen, Komplimente.'},
{id:'verein',c:'social',i:'‚öΩ',n:'Sportverein',d:'Anmeldung, Training',l:'B1',p:'Sportverein. Trainingszeiten, Mitgliedschaft.'},
{id:'kult',c:'social',i:'üé≠',n:'Theater & Kino',d:'Filme diskutieren',l:'B2',p:'Film/Theaterst√ºck besprechen. Handlung, Meinung.'},
{id:'deb',c:'social',i:'üí¨',n:'Politische Diskussion',d:'Argumente austauschen',l:'C1',p:'Sachliche Diskussion: Klima, Bildung, Digitalisierung.'},
{id:'phil',c:'social',i:'ü§î',n:'Philosophie',d:'Leben und Werte',l:'C1',p:'Tiefgr√ºndig: Lebenssinn, Werte, Gl√ºck, Gesellschaft.'},
// OFFICIAL
{id:'anm',c:'offi',i:'üìã',n:'Anmeldung Amt',d:'Wohnsitz anmelden',l:'B1',p:'B√ºrgeramt. Wohnsitz-Anmeldung, Dokumente, Formulare.'},
{id:'bank',c:'offi',i:'üè¶',n:'Bei der Bank',d:'Konto er√∂ffnen',l:'B1',p:'Bankberater. Kontoer√∂ffnung, Online-Banking.'},
{id:'beh',c:'offi',i:'üèõÔ∏è',n:'Ausl√§nderbeh√∂rde',d:'Aufenthaltstitel',l:'B2',p:'Ausl√§nderbeh√∂rde. Aufenthaltstitel, Dokumente, Fristen.'},
{id:'pol',c:'offi',i:'üëÆ',n:'Polizei',d:'Anzeige erstatten',l:'B2',p:'Polizei. Anzeige: Vorfall, Tatort, Beschreibung.'},
{id:'vers',c:'offi',i:'üìÑ',n:'Versicherung',d:'Beratung, Tarife',l:'B2',p:'Versicherungsberater. Typen, Tarife, Leistungen.'},
{id:'steu',c:'offi',i:'üßÆ',n:'Steuerberater',d:'Steuererkl√§rung',l:'C1',p:'Steuerberater. Steuererkl√§rung, Freibetr√§ge.'},
{id:'anw',c:'offi',i:'‚öñÔ∏è',n:'Beim Anwalt',d:'Rechtliche Beratung',l:'C1',p:'Rechtsanwalt. Mietrecht, Arbeitsrecht beraten.'},
// EDUCATION
{id:'kurs',c:'edu',i:'üìñ',n:'Sprachkurs',d:'Grammatik √ºben',l:'A1',p:'Deutschlehrer A1. Grammatik, Aussprache, einfache Fragen.'},
{id:'bib',c:'edu',i:'üìö',n:'Bibliothek',d:'B√ºcher ausleihen',l:'A2',p:'Bibliothek. Anmelden, B√ºcher suchen, Regeln.'},
{id:'nachhilfe',c:'edu',i:'‚úèÔ∏è',n:'Nachhilfe',d:'Bei Hausaufgaben helfen',l:'B1',p:'Kind braucht Hilfe bei Hausaufgaben. Fragen, Frustration.'},
{id:'uni',c:'edu',i:'üéì',n:'Universit√§t',d:'Einschreibung, Kurse',l:'B2',p:'Studienberater. Einschreibung, Kurswahl, Pr√ºfungen.'},
{id:'vort',c:'edu',i:'üé§',n:'Referat',d:'Pr√§sentation vorbereiten',l:'B2',p:'Referat vorbereiten. Thema, Struktur, √ºben.'},
// TRAVEL
{id:'hotel',c:'trav',i:'üè®',n:'Im Hotel',d:'Einchecken, Service',l:'A2',p:'Rezeptionist. Check-in, Services, Beschwerden.'},
{id:'tour',c:'trav',i:'‚ÑπÔ∏è',n:'Touristeninfo',d:'Sehensw√ºrdigkeiten',l:'A2',p:'Touristeninformation. Empfehlungen, Tipps.'},
{id:'reise',c:'trav',i:'üåç',n:'Reiseb√ºro',d:'Urlaub planen',l:'B1',p:'Reiseberater. Ziele, Hotels, Fl√ºge, Budget.'},
{id:'wand',c:'trav',i:'ü•æ',n:'Wanderung',d:'Route, Ausr√ºstung',l:'B1',p:'Wanderung planen. Route, Schwierigkeit, Wetter.'},
{id:'mus',c:'trav',i:'üñºÔ∏è',n:'Museum',d:'Ausstellung besprechen',l:'B2',p:'Museumsf√ºhrer. Kunstwerke, Geschichte erkl√§ren.'},
// EMERGENCY
{id:'not',c:'emer',i:'üÜò',n:'Notruf 112',d:'Hilfe rufen',l:'A2',p:'Notruf 112. Was? Wo? Verletzte?'},
{id:'unf',c:'emer',i:'üö®',n:'Verkehrsunfall',d:'Unfall melden',l:'B1',p:'Leichter Unfall. Daten tauschen, Hergang beschreiben.'},
{id:'verl',c:'emer',i:'üò∞',n:'Etwas verloren',d:'Fundb√ºro',l:'A2',p:'Fundb√ºro. Was verloren, wo, wann.'},
// TECH
{id:'handy',c:'tech',i:'üì±',n:'Handyladen',d:'Vertrag, Beratung',l:'B1',p:'Handyladen. Smartphones, Tarife, Vertrag vs Prepaid.'},
{id:'itsup',c:'tech',i:'üíª',n:'IT-Support',d:'Technisches Problem',l:'B2',p:'IT-Support. Computer-Problem diagnostizieren und l√∂sen.'},
{id:'ki',c:'tech',i:'ü§ñ',n:'√úber KI diskutieren',d:'Chancen und Risiken',l:'C1',p:'KI-Diskussion. Chancen, Risiken, Ethik, Zukunft.'},
];

const CATS=[
{id:'free',i:'üó£Ô∏è',n:'Freie Gespr√§che'},
{id:'daily',i:'üõí',n:'Alltag & Einkaufen'},
{id:'trans',i:'üöå',n:'Transport'},
{id:'health',i:'üè•',n:'Gesundheit'},
{id:'work',i:'üíº',n:'Arbeit & Beruf'},
{id:'hous',i:'üè†',n:'Wohnen'},
{id:'social',i:'üéâ',n:'Soziales & Freizeit'},
{id:'offi',i:'üèõÔ∏è',n:'Beh√∂rden & Finanzen'},
{id:'edu',i:'üìñ',n:'Bildung'},
{id:'trav',i:'üåç',n:'Reisen'},
{id:'emer',i:'üÜò',n:'Notf√§lle'},
{id:'tech',i:'üíª',n:'Technologie'},
];

// STATE
const D={
  key:localStorage.getItem('dk')||'',
  lv:localStorage.getItem('dl')||'A1',
  sc:null,hist:[],mode:'t',rec:false,sr:null,
  streak:+(localStorage.getItem('ds')||'0'),
  last:localStorage.getItem('dd')||'',
  stats:JSON.parse(localStorage.getItem('dt')||'{"c":0,"co":0,"w":0}'),
  mist:JSON.parse(localStorage.getItem('dm')||'[]'),
  chats:JSON.parse(localStorage.getItem('dch')||'[]'),
  set:{cor:true,voc:true,pro:true,str:false,slo:true},
  oc:JSON.parse(localStorage.getItem('do')||'{}'),
  curChatMsgs:[] // track displayed messages for saving
};

function $(id){return document.getElementById(id)}
function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML}

// INIT
function init(){rLv();rLvI();rSc();uSt();uStrk();if(!D.key)setTimeout(showApi,800);initSR();}
function initSR(){
  if(!('webkitSpeechRecognition' in window||'SpeechRecognition' in window))return;
  const R=window.SpeechRecognition||window.webkitSpeechRecognition;
  D.sr=new R();D.sr.lang='de-DE';D.sr.interimResults=true;D.sr.continuous=false;
  D.sr.onresult=e=>{let t='';for(let i=0;i<e.results.length;i++)t+=e.results[i][0].transcript;$('vtr').textContent=t;if(e.results[e.results.length-1].isFinal){stopR();if(t.trim())send(t.trim());}};
  D.sr.onerror=e=>{stopR();$('vst').textContent=e.error==='no-speech'?'Keine Sprache erkannt':'Fehler: '+e.error;};
  D.sr.onend=()=>{if(D.rec)stopR();};
}

// LEVEL
function rLv(){$('lvlS').innerHTML=Object.keys(LV).map(k=>`<button class="lvb${k===D.lv?' on':''}" data-l="${k}" onclick="sLv('${k}')">${k}</button>`).join('')}
function sLv(l){D.lv=l;localStorage.setItem('dl',l);rLv();rLvI();rSc();}
function rLvI(){const l=LV[D.lv],e=$('lvI');e.style.background=l.bg;e.style.borderColor=l.bd;e.innerHTML=`<h2 style="color:${l.co}">${l.nm}</h2><p>${l.ds}</p><div class="lvt">${l.tg.map(t=>`<span>${t}</span>`).join('')}</div>`}

// SCENARIOS
function rSc(){
  const box=$('scenBox'),lo=Object.keys(LV),li=lo.indexOf(D.lv);
  const show=lo.slice(Math.max(0,li),Math.min(lo.length,li+2));
  let h='';
  CATS.forEach(cat=>{
    const items=SC.filter(s=>s.c===cat.id&&show.includes(s.l));
    if(!items.length)return;
    const op=D.oc[cat.id]!==false;
    h+=`<div class="cs"><div class="ch" onclick="tCat('${cat.id}')"><span class="ci">${cat.i}</span><span class="cn">${cat.n}</span><span class="cc">${items.length}</span><span class="ca${op?' op':''}">‚ñ∂</span></div><div class="sg" id="c_${cat.id}" style="${op?'':'display:none'}">${items.map(s=>`<div class="sc" onclick="sSc('${s.id}')"><span class="si">${s.i}</span><div class="sn">${s.n}</div><div class="sd">${s.d}</div><span class="sl b${s.l}">${s.l}</span></div>`).join('')}</div></div>`;
  });
  box.innerHTML=h||'<div class="empty"><p>Keine Szenarien verf√ºgbar.</p></div>';
}
function tCat(id){const g=$('c_'+id),v=g.style.display!=='none';g.style.display=v?'none':'grid';D.oc[id]=!v;localStorage.setItem('do',JSON.stringify(D.oc));g.previousElementSibling.querySelector('.ca').classList.toggle('op',!v);}

// NAVIGATION
function go(s){
  document.querySelectorAll('.scr').forEach(e=>e.classList.remove('on'));
  if(s==='home'){$('homeScr').classList.add('on');uSt();}
  else if(s==='chat')$('chatScr').classList.add('on');
  else if(s==='hist'){$('histScr').classList.add('on');showHTab('chats');}
  else if(s==='mist'){$('mistScr').classList.add('on');rMist();}
  else if(s==='data'){$('histScr').classList.add('on');showHTab('chats');}
}

// START CHAT
function sSc(id){
  const sc=SC.find(s=>s.id===id);if(!sc)return;
  D.sc=sc;D.hist=[];D.curChatMsgs=[];
  $('chN').textContent=sc.i+' '+sc.n;$('chH').textContent=sc.d;
  const t=$('chT');t.textContent=sc.l;t.className='ctg b'+sc.l;
  $('msgs').innerHTML='';go('chat');
  addMsg('sys',`${sc.n} ‚Äî ${sc.d} (${sc.l})`);
  callAI(sysP(sc),[{role:'user',content:'Starte das Gespr√§ch. Begr√º√üe mich passend zum Szenario.'}],true);
}
function startFree(){
  D.sc={id:'free',i:'üó£Ô∏è',n:'Freies Gespr√§ch',d:'Sprich √ºber alles',l:D.lv,p:'Freies Gespr√§ch auf Deutsch. Passe dich dem Thema an. Schlage 2-3 Themen vor wenn der Benutzer unsicher ist.'};
  D.hist=[];D.curChatMsgs=[];
  $('chN').textContent='üó£Ô∏è Freies Gespr√§ch';$('chH').textContent='Sprich √ºber alles';
  const t=$('chT');t.textContent=D.lv;t.className='ctg b'+D.lv;
  $('msgs').innerHTML='';go('chat');
  addMsg('sys','Freies Gespr√§ch ‚Äî '+D.lv);
  callAI(sysP(D.sc),[{role:'user',content:'Begr√º√üe mich, schlage 2-3 Gespr√§chsthemen vor und stelle eine Frage.'}],true);
}
function endChat(){
  // Auto-save chat if it has messages
  if(D.curChatMsgs.length>1){
    const chat={id:Date.now(),name:D.sc?.n||'Chat',icon:D.sc?.i||'üí¨',level:D.sc?.l||D.lv,date:new Date().toISOString(),messages:D.curChatMsgs};
    D.chats.unshift(chat);
    if(D.chats.length>50)D.chats=D.chats.slice(0,50);
    localStorage.setItem('dch',JSON.stringify(D.chats));
  }
  go('home');
}

// MESSAGES
function addMsg(type,html,save=true){
  const c=$('msgs'),d=document.createElement('div');
  d.className='msg '+(type==='sys'?'sys':type==='usr'?'usr':'bot');
  d.innerHTML=html;c.appendChild(d);c.scrollTop=c.scrollHeight;
  if(save)D.curChatMsgs.push({type,html,time:Date.now()});
  return d;
}
function addTyp(){const c=$('msgs'),d=document.createElement('div');d.className='typ';d.id='typI';d.innerHTML='<div class="dot"></div><div class="dot"></div><div class="dot"></div>';c.appendChild(d);c.scrollTop=c.scrollHeight;}
function rmTyp(){const e=$('typI');if(e)e.remove();}

// SEND
function send(vt){
  const t=vt||$('inp').value.trim();if(!t)return;
  if(!D.key){showApi();return;}
  addMsg('usr',esc(t));
  if(!vt){$('inp').value='';$('inp').style.height='auto';}
  D.hist.push({role:'user',content:t});addTyp();
  callAI(sysP(D.sc),D.hist,false);
}

// SYSTEM PROMPT
function sysP(sc){
  const lv=sc.l||D.lv,li=LV[lv]||LV.A1;
  const rules={A1:'NUR einfache kurze S√§tze (1-2). Nur Pr√§sens. Grundwortschatz. IMMER englische √úbersetzung.',A2:'Einfache-mittlere S√§tze (2-3). Perfekt, Modalverben. Alltagswortschatz. √úbersetzungen bei schwierigen W√∂rtern.',B1:'Komplexere S√§tze (3-4). Konjunktiv II, Relativs√§tze, Passiv. Redewendungen. Englisch bei Bedarf.',B2:'Anspruchsvoll, Konnektoren. Konjunktiv II, Passiv alle Zeiten. Fachvokabular. L√§ngere Antworten f√∂rdern.',C1:'Gehobene Sprache, Konjunktiv I, Idiome, Partizipialgruppen. Nuancierte Antworten. Korrekturen auf Deutsch.'};
  return `Du bist DeutschCoach, ein freundlicher KI-Sprachpartner.
NIVEAU: ${lv} (${li.nm}) | GRAMMATIK: ${li.gr}
SZENARIO: ${sc.p}
REGELN: ${rules[lv]||rules.A1}
${D.set.cor?'Korrigiere JEDEN Fehler.':'Nur schwere Fehler.'}
${D.set.voc?'Erkl√§re neue W√∂rter.':''}${D.set.pro?' Aussprache-Tipps.':''}
${D.set.str?'NUR Deutsch.':lv==='A1'||lv==='A2'?'Englisch bei Schwierigkeiten.':''}
Lobe gute S√§tze! Stelle immer eine Folgefrage.
ANTWORTE NUR als JSON: {"reply":"...","corrections":[{"wrong":"...","right":"...","explanation":"...","category":"grammar|vocabulary|word-order|case|gender|conjugation"}],"vocabulary":[{"word":"...","meaning":"...","example":"..."}],"hint":"...","praise":"..."}`;
}

// CLAUDE API
async function callAI(sys,msgs,init){
  try{
    const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':D.key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1024,system:sys,messages:init?msgs:[...msgs]})});
    rmTyp();
    if(!r.ok){const e=await r.json();addMsg('sys','‚ö†Ô∏è '+(e.error?.message||r.statusText));return;}
    const d=await r.json(),ct=d.content[0].text;
    let p;try{const m=ct.match(/\{[\s\S]*\}/);p=JSON.parse(m?m[0]:ct);}catch(e){const msg=addMsg('bot',esc(ct));addSpk(msg,ct);if(!init)D.hist.push({role:'assistant',content:ct});return;}
    let h=`<div>${esc(p.reply)}</div>`;
    if(p.praise)h+=`<div style="margin-top:5px;color:var(--gn);font-size:11px">‚ú® ${esc(p.praise)}</div>`;
    if(p.corrections?.length){p.corrections.forEach(c=>{h+=`<div class="cor"><div class="lb">‚úèÔ∏è Korrektur</div><span class="cw">${esc(c.wrong)}</span> ‚Üí <span class="cr">${esc(c.right)}</span><div class="ce">${esc(c.explanation)}</div></div>`;saveMi(c);});D.stats.co+=p.corrections.length;}
    if(p.vocabulary?.length){p.vocabulary.forEach(v=>{h+=`<div class="voc"><div class="lb">üìö Vokabel</div><strong>${esc(v.word)}</strong> ‚Äî ${esc(v.meaning)}${v.example?`<div style="margin-top:2px;font-style:italic;opacity:.8">"${esc(v.example)}"</div>`:''}</div>`;D.stats.w++;});}
    if(p.hint)h+=`<div class="hnt"><div class="lb">üí° Tipp</div>${esc(p.hint)}</div>`;
    const msg=addMsg('bot',h);addSpk(msg,p.reply);
    if(!init)D.hist.push({role:'assistant',content:ct});else D.hist=[{role:'assistant',content:ct}];
    if(init)D.stats.c++;uStrk();savD();
  }catch(e){rmTyp();addMsg('sys','‚ö†Ô∏è '+e.message);}
}

// TTS
function addSpk(el,txt){if(!('speechSynthesis' in window))return;const b=document.createElement('button');b.className='spk';b.innerHTML='üîä Anh√∂ren';b.onclick=()=>spk(txt);el.appendChild(b);}
function spk(txt){if(!('speechSynthesis' in window))return;speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(txt);u.lang='de-DE';const lv=D.sc?.l||D.lv;u.rate=D.set.slo?(LV[lv]?.rt||.85):1;const v=speechSynthesis.getVoices(),de=v.find(x=>x.lang.startsWith('de'));if(de)u.voice=de;speechSynthesis.speak(u);}
if('speechSynthesis' in window)speechSynthesis.onvoiceschanged=()=>speechSynthesis.getVoices();

// VOICE
function setMode(m){D.mode=m;$('mtT').classList.toggle('on',m==='t');$('mtV').classList.toggle('on',m==='v');$('tia').classList.toggle('off',m==='v');$('via').classList.toggle('on',m==='v');}
function togRec(){if(!D.sr){$('vst').textContent='Nicht verf√ºgbar';return;}D.rec?stopR():startR();}
function startR(){D.rec=true;$('micB').classList.add('rec');$('vst').textContent='H√∂re zu...';$('vtr').textContent='...';try{D.sr.start();}catch(e){}}
function stopR(){D.rec=false;$('micB').classList.remove('rec');$('vst').textContent='Tippe zum Sprechen';try{D.sr.stop();}catch(e){}}

// MISTAKES
function saveMi(c){D.mist.unshift({w:c.wrong,r:c.right,e:c.explanation,c:c.category||'grammar',d:new Date().toISOString()});if(D.mist.length>200)D.mist=D.mist.slice(0,200);savD();}
function rMist(){
  const el=$('mistC');
  if(!D.mist.length){el.innerHTML='<div class="empty"><div class="ic">üìù</div><p>Noch keine Fehler!</p></div>';return;}
  const cm={grammar:{l:'Grammatik',c:'cg'},vocabulary:{l:'Wortschatz',c:'cv'},'word-order':{l:'Wortstellung',c:'cw'},case:{l:'Kasus',c:'cg'},gender:{l:'Genus',c:'cg'},conjugation:{l:'Konjugation',c:'cg'}};
  el.innerHTML=`<div style="margin-bottom:10px;display:flex;justify-content:space-between;align-items:center"><span style="font-size:11px;color:var(--t3)">${D.mist.length} Fehler</span><button onclick="clrMi()" style="background:none;border:1px solid var(--bd);color:var(--t3);padding:4px 9px;border-radius:6px;font-size:10px;cursor:pointer;font-family:inherit">L√∂schen</button></div>${D.mist.map(m=>{const ct=cm[m.c]||cm.grammar;return`<div class="mk"><span class="mc ${ct.c}">${ct.l}</span><div class="mw">${esc(m.w)}</div><div class="mr">‚Üí ${esc(m.r)}</div><div class="me">${esc(m.e)}</div></div>`;}).join('')}`;
}
function clrMi(){if(confirm('Alle Fehler l√∂schen?')){D.mist=[];savD();rMist();}}

// HISTORY TABS
function showHTab(tab){
  $('htC').classList.toggle('on',tab==='chats');$('htM').classList.toggle('on',tab==='mist');
  const box=$('histBox');
  if(tab==='chats'){
    if(!D.chats.length){box.innerHTML='<div class="empty"><div class="ic">üí¨</div><p>Noch keine gespeicherten Chats. Chats werden automatisch gespeichert wenn du zur√ºckgehst.</p></div>';return;}
    box.innerHTML=D.chats.map((c,i)=>{
      const d=new Date(c.date);const ds=d.toLocaleDateString('de-DE',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'});
      const last=c.messages?.filter(m=>m.type==='bot')[0];
      return`<div class="hc" onclick="loadChat(${i})"><div class="ht">${c.icon||'üí¨'} ${esc(c.name)} <span class="sl b${c.level}" style="font-size:8px;padding:1px 5px">${c.level}</span></div><div class="hd">${ds} ¬∑ ${c.messages?.length||0} Nachrichten</div>${last?`<div class="hm">${esc(last.html?.replace(/<[^>]*>/g,'').slice(0,80)||'')}</div>`:''}</div>`;
    }).join('')+`<button onclick="clrChats()" style="width:100%;margin-top:8px;background:none;border:1px solid var(--bd);color:var(--t3);padding:8px;border-radius:8px;font-size:10px;cursor:pointer;font-family:inherit">Alle Chats l√∂schen</button>`;
  } else {
    if(!D.mist.length){box.innerHTML='<div class="empty"><div class="ic">üìù</div><p>Noch keine Fehler!</p></div>';return;}
    const cm={grammar:{l:'Grammatik',c:'cg'},vocabulary:{l:'Wortschatz',c:'cv'},'word-order':{l:'Wortstellung',c:'cw'},case:{l:'Kasus',c:'cg'},gender:{l:'Genus',c:'cg'},conjugation:{l:'Konjugation',c:'cg'}};
    box.innerHTML=D.mist.map(m=>{const ct=cm[m.c]||cm.grammar;return`<div class="mk"><span class="mc ${ct.c}">${ct.l}</span><div class="mw">${esc(m.w)}</div><div class="mr">‚Üí ${esc(m.r)}</div><div class="me">${esc(m.e)}</div></div>`;}).join('');
  }
}
function loadChat(i){
  const c=D.chats[i];if(!c)return;
  D.sc={id:'loaded',i:c.icon,n:c.name,d:'Gespeicherter Chat',l:c.level,p:'Setze das Gespr√§ch fort.'};
  D.hist=[];D.curChatMsgs=[];
  $('chN').textContent=(c.icon||'üí¨')+' '+c.name;$('chH').textContent='Gespeicherter Chat';
  const t=$('chT');t.textContent=c.level;t.className='ctg b'+c.level;
  $('msgs').innerHTML='';go('chat');
  // Replay messages
  (c.messages||[]).forEach(m=>{
    const d=document.createElement('div');
    d.className='msg '+(m.type==='sys'?'sys':m.type==='usr'?'usr':'bot');
    d.innerHTML=m.html;$('msgs').appendChild(d);
    D.curChatMsgs.push(m);
    // Rebuild hist for API
    if(m.type==='usr')D.hist.push({role:'user',content:m.html.replace(/<[^>]*>/g,'')});
    else if(m.type==='bot')D.hist.push({role:'assistant',content:m.html.replace(/<[^>]*>/g,'')});
  });
  $('msgs').scrollTop=$('msgs').scrollHeight;
}
function clrChats(){if(confirm('Alle Chats l√∂schen?')){D.chats=[];localStorage.setItem('dch','[]');showHTab('chats');}}

// EXPORT / IMPORT
function exportData(){
  const data={version:2,date:new Date().toISOString(),stats:D.stats,mistakes:D.mist,chats:D.chats,level:D.lv,streak:D.streak,lastDate:D.last};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=`deutschcoach_backup_${new Date().toISOString().slice(0,10)}.json`;a.click();
  URL.revokeObjectURL(url);
}
function importData(event){
  const file=event.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const data=JSON.parse(e.target.result);
      if(data.stats)D.stats=data.stats;
      if(data.mistakes)D.mist=data.mistakes;
      if(data.chats)D.chats=data.chats;
      if(data.level){D.lv=data.level;localStorage.setItem('dl',D.lv);}
      if(data.streak){D.streak=data.streak;localStorage.setItem('ds',D.streak);}
      if(data.lastDate){D.last=data.lastDate;localStorage.setItem('dd',D.last);}
      savD();localStorage.setItem('dch',JSON.stringify(D.chats));
      uSt();uStrk();rLv();rLvI();rSc();
      alert('‚úÖ Daten erfolgreich importiert! '+D.chats.length+' Chats, '+D.mist.length+' Fehler.');
      showHTab('chats');
    }catch(err){alert('‚ùå Fehler beim Importieren: '+err.message);}
  };
  reader.readAsText(file);event.target.value='';
}

// SETTINGS
function togSet(){$('setP').classList.toggle('on');}
function togS(el){el.classList.toggle('on');const m={tgCor:'cor',tgVoc:'voc',tgPro:'pro',tgStr:'str',tgSlo:'slo'};const k=m[el.id];if(k)D.set[k]=el.classList.contains('on');}

// API
function showApi(){$('apiMo').classList.add('on');$('apiIn').value=D.key;const s=$('apiS');s.className='apis';s.style.display='none';}
function closeApi(){$('apiMo').classList.remove('on');}
async function saveApi(){
  const k=$('apiIn').value.trim();if(!k)return;
  const s=$('apiS');s.textContent='‚è≥ Teste...';s.style.display='block';s.style.background='rgba(245,166,35,.1)';s.style.color='var(--gd)';s.style.border='1px solid rgba(245,166,35,.2)';s.className='apis';
  try{
    const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':k,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:50,messages:[{role:'user',content:'Sag "Hallo!"'}]})});
    if(r.ok){D.key=k;localStorage.setItem('dk',k);s.textContent='‚úÖ Verbunden!';s.className='apis ok';setTimeout(closeApi,1000);}
    else{const e=await r.json();s.textContent='‚ùå '+(e.error?.message||'Ung√ºltig');s.className='apis er';}
  }catch(e){s.textContent='‚ùå '+e.message;s.className='apis er';}
}

// STATS
function uStrk(){const today=new Date().toDateString();if(D.last!==today){const y=new Date(Date.now()-864e5).toDateString();D.streak=D.last===y?D.streak+1:1;D.last=today;localStorage.setItem('dd',today);localStorage.setItem('ds',D.streak);}$('strk').textContent=D.streak;}
function uSt(){$('s1').textContent=D.stats.c;$('s2').textContent=D.stats.co;$('s3').textContent=D.stats.w;}
function savD(){localStorage.setItem('dt',JSON.stringify(D.stats));localStorage.setItem('dm',JSON.stringify(D.mist));}

init();
</script>
</body>
</html>
